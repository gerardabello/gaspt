!function(t){var e={};function r(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return t[s].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,s){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(s,i,function(e){return t[e]}.bind(null,i));return s},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);const s=3.141592653589793;function i(t,e,r){return t>r?r:t<e?e:t}function n(){return Math.random()}class a{constructor(t,e,r){Array.isArray(t)?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=r)}static minus(t){return new a(-t.x,-t.y,-t.z)}static add(t,e){return new a(t.x+e.x,t.y+e.y,t.z+e.z)}static sub(t,e){return new a(t.x-e.x,t.y-e.y,t.z-e.z)}static scale(t,e){return new a(t.x*e,t.y*e,t.z*e)}static mul(t,e){return new a(t.x*e.x,t.y*e.y,t.z*e.z)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e){return new a(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)}static eq(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static ne(t,e){return t.x!==e.x||t.y!==e.y||t.z!==e.z}static lt(t,e){return t.x<e.x&&t.y<e.y&&t.z<e.z}static le(t,e){return t.x<=e.x&&t.y<=e.y&&t.z<=e.z}static gt(t,e){return t.x>e.x&&t.y>e.y&&t.z>e.z}static ge(t,e){return t.x>=e.x&&t.y>=e.y&&t.z>=e.z}static map(t,e){return new a(t(e.x),t(e.y),t(e.z))}static sqrt(t){return a.map(Math.sqrt,t)}static pow(t,e){return a.map(t=>t**e,t)}static abs(t){return a.map(Math.abs,t)}static round(t){return a.map(Math.round,t)}static ceil(t){return a.map(Math.ceil,t)}static floor(t){return a.map(Math.floor,t)}static trunc(t){return a.map(Math.trunc,t)}static clamp(t,e,r){return a.map(t=>i(t,e,r),t)}static lerp(t,e,r){return a.add(e,a.scale(a.sub(r,e),t))}static permute(t,e,r,s){return new a(t.get(e),t.get(r),t.get(s))}copy(){return new a(this.x,this.y,this.z)}set(t,e,r){this.x=t,this.y=e,this.z=r}get(t){switch(t){case 0:return this.x;case 1:return this.y;default:return this.z}}getX(){return this.x}getY(){return this.y}getZ(){return this.z}minDimension(){return this.x<this.y&&this.x<this.z?0:this.y<this.z?1:2}maxDimension(){return this.x>this.y&&this.x>this.z?0:this.y>this.z?1:2}minValue(){return this.x<this.y&&this.x<this.z?this.x:this.y<this.z?this.y:this.z}maxValue(){return this.x>this.y&&this.x>this.z?this.x:this.y>this.z?this.y:this.z}norm2Squared(){return this.x*this.x+this.y*this.y+this.z*this.z}norm2(){return Math.sqrt(this.norm2Squared())}normalize(){let t=1/this.norm2();return this.x*=t,this.y*=t,this.z*=t,this}static fromAngles(t,e){return new a(Math.cos(t)*Math.cos(e),Math.sin(e),Math.sin(t)*Math.cos(e))}static randomInSphere(){return a.fromAngles(n()*Math.PI*2,Math.asin(2*n()-1))}randomInCone(t){const e=n(),r=n(),s=.5*t*Math.PI*(1-2*Math.acos(e)/Math.PI),i=Math.sin(s),o=Math.cos(s),c=2*r*Math.PI,h=a.randomInSphere(),l=a.cross(this,h),u=a.cross(this,l);let d=a.scale(l,i*Math.cos(c));return d=a.add(d,a.scale(u,i*Math.sin(c))),(d=a.add(d,a.scale(this,o))).normalize()}}var o=a;var c=class{constructor(t){t instanceof o?(this.type="color",this.color=t.copy()):null==t?(this.type="color",this.color=new o(0,0,0)):Array.isArray(t)?(this.type="color",this.color=new o(t)):(this.type="image",this.pixels=t.pixels,this.imgHeight=t.h,this.imgWidth=t.w)}getUVValue(t,e){const r=t*this.imgWidth,s=e*this.imgHeight,i=4*(Math.floor(s)*this.imgWidth+Math.floor(r)),n=new o(this.pixels[i],this.pixels[i+1],this.pixels[i+2]),a=n.length>441?2:1;return o.scale(n,a/255)}background(t){if("color"===this.type)return this.color;const e=Math.sqrt(t.x*t.x+t.y*t.y),r=.159154943*Math.acos(t.z)/e,s=.5+t.x*r,i=.5+t.y*-r;return this.getUVValue(s,i)}};const h=new o(0,1,0),l=new o(1,0,0);function u(t,e){let r=o.dot(e,t)<0?e:o.minus(e),i=o.cross(Math.abs(r.x)>.1?h:l,r).normalize(),a=o.cross(r,i),c=function(t,e){let r=Math.sqrt(1-t),i=Math.sqrt(t),n=2*s*e;return new o(Math.cos(n)*i,Math.sin(n)*i,r)}(n(),n());return o.add(o.add(o.scale(i,c.x),o.scale(a,c.y)),o.scale(r,c.z)).normalize()}function d(t,e){const r=o.dot(e,t);return o.sub(t,o.scale(e,2*r))}var y=class{constructor({color:t,gloss:e}){this.color=new o(t),this.gloss=e}reflect(t,e,r){t.addFilter(this.color);const s=u(t.ray.d,r);return t.bounce(e,s),!0}};var m=class{constructor({color:t,roughness:e=0}){this.color=new o(t),this.roughness=e}reflect(t,e,r){const s=o.dot(r,t.ray.d)<0?r:o.minus(r);let i=d(t.ray.d,s);return 0!==this.roughness&&(i=function(t,e){let r=o.cross(Math.abs(t.x)>.1?h:l,t).normalize(),s=o.cross(t,r);return o.add(o.add(o.scale(r,e.x),o.scale(s,e.y)),o.scale(t,e.z)).normalize()}(i=o.lerp(this.roughness,i,s),function(t,e,r=1){const s=Math.acos(Math.pow(1-t,1/(1+r))),i=2*Math.PI*e;return new o(Math.cos(i)*Math.sin(s),Math.sin(i)*Math.sin(s),Math.cos(s))}(n(),n(),1e3-1e3*Math.pow(this.roughness,.1)))),t.addFilter(this.color),t.bounce(e,i),!0}};const f=1,x=1.5;var p=class{constructor({color:t}){this.color=new o(t)}reflect(t,e,r){let s=function(t,e,r,s){let i=d(t,e),a=o.dot(e,t)<0,c=a?e:o.minus(e),h=a?r/s:s/r,l=o.dot(t,c),u=1-h*h*(1-l*l);if(u<0)return[i,1];let y=o.sub(o.scale(t,h),o.scale(c,h*l+Math.sqrt(u))).normalize(),m=function(t,e,r){let s=function(t,e){let r=(t-e)/(t+e);return r*r}(t,e);return s+(1-s)*r*r*r*r*r}(r,s,1-(a?-l:o.dot(y,e))),f=.25+.5*m;return n()<f?[i,m/f]:[y,(1-m)/(1-f)]}(t.ray.d,r,f,x),i=s[0],a=s[1];return t.addFilter(this.color),t.addFilter(new o(a,a,a)),t.bounce(e,i),!0}};var g=class{constructor({emission:t}){this.emission=new o(t)}reflect(t,e,r){return t.addEmission(this.emission),!1}};var z=class{constructor({mix:t,materials:e}){if(2!==e.length)throw new Error("Mix must use two materials");this.materials=e.map(w),this.mix=t}reflect(t,e,r){let s;return(s=Math.random()>this.mix?this.materials[0]:this.materials[1]).reflect(t,e,r)}};const w=t=>{switch(t.type){case"diffuse":return new y(t);case"specular":return new m(t);case"refractive":return new p(t);case"emission":return new g(t);case"mix":return new z(t)}},M=1e-4;class b{constructor(t,e,r){this.r=t,this.p=e.copy(),this.material=r}getMaterial(){return this.material}intersect(t){let e=o.sub(this.p,t.o),r=o.dot(t.d,e),s=r*r-o.dot(e,e)+this.r*this.r;if(s<0)return!1;let i=Math.sqrt(s),n=r-i;if(M<n&&n<t.length)return t.length=n,!0;let a=r+i;return M<a&&a<t.length&&(t.length=a,!0)}}var v=t=>Object.assign({},t,{enviroment:new c(t.enviroment),objects:t.objects.map(t=>(t=>{const e=w(t.material);return new b(t.radius,new o(t.position),e)})(t))});var q=class{constructor(t,e,r){this.o=t.copy(),this.d=e.copy(),this.length=r}eval(t){return o.add(this.o,o.scale(this.d,t))}};class j{constructor(t,e,r,s,i,n=1){this.position=t,this.direction=e,this.width=r*n,this.height=s*n,this.cx=new o(this.width*i/this.height,0,0),this.cy=o.scale(o.cross(this.cx,this.direction).normalize(),i)}getDirection(t,e,r,s){let i=2*n(),a=2*n(),c=i<1?Math.sqrt(i)-1:1-Math.sqrt(2-i),h=a<1?Math.sqrt(a)-1:1-Math.sqrt(2-a);return o.add(o.add(o.scale(this.cx,((r+.5+c)/2+t)/this.width-.5),o.scale(this.cy,((s+.5+h)/2+e)/this.height-.5)),this.direction)}getRay(t,e,r,s){const i=this.getDirection(t,e,r,s);return new q(o.add(this.position,o.scale(i,130)),i.normalize(),1/0)}}var P=class{constructor(t,e,r){this.ray=t,this.energy=e,this.filter=r,this.bounces=0}addEmission(t){this.energy=o.add(this.energy,o.mul(this.filter,t))}addFilter(t){this.filter=o.mul(this.filter,t)}bounce(t,e){this.bounces+=1,this.ray.o=t,this.ray.d=e,this.ray.length=1/0}};let S,A;function I(t,e){let r;for(let s=0;s<e.objects.length;++s)e.objects[s].intersect(t)&&(r=s);return r}function O(t,e){let r=new P(t,new o(0,0,0),new o(1,1,1));for(;;){const t=I(r.ray,e);if(null==t){const t=e.enviroment.background(r.ray.d);return r.addEmission(t),r.energy}let s=e.objects[t],i=r.ray.eval(r.ray.length),a=o.sub(i,s.p).normalize();if(!s.material.reflect(r,i,a))return r.energy;if(r.bounces>4){let t=r.filter.maxValue();if(n()>=t)return r.energy;r.filter=o.scale(r.filter,1/t)}}}r.d(e,"default",function(){return _}),r.d(e,"init",function(){return D});const F=(t,e,r)=>{const s=3*e;t[s]=r.x,t[s+1]=r.y,t[s+2]=r.z},V=(t,e)=>{const r=3*e;return new o(t[r],t[r+1],t[r+2])};function _(t,e,r,s){let i=s;const n=new j(new o(S.camera.position),new o(S.camera.direction).normalize(),t,e,S.camera.fov);let a=new Float32Array(n.width*r.h*3);for(let t=r.y;t<r.y+r.h;++t)for(let e=0;e<n.width;++e){let s=(t-r.y)*n.width+e;for(let r=0;r<2;++r)for(let c=0;c<2;++c){let h=new o(0,0,0);for(let s=0;s<i;++s){const s=n.getRay(e,t,c,r);h=o.add(h,o.scale(O(s,S),1/i))}F(a,s,o.add(V(a,s),o.scale(o.clamp(h,0,1),.25)))}}A.set(a,r.y*n.width*3)}const D=(t,e)=>{A=new Float32Array(t),S=v(e)};onmessage=function(t){if("init"===t.data.type)D(t.data.payload.buffer,t.data.payload.scene);else if("render"===t.data.type){const{samples:e,width:r,split:s,height:i}=t.data.payload;_(r,i,s,e),postMessage({type:"render_finished"})}}}]);
//# sourceMappingURL=325dd0bbad4c981edbc5.worker.js.map