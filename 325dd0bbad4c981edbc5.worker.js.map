{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/path-tracing/math_tools.js","webpack:///./src/path-tracing/random.js","webpack:///./src/path-tracing/vector.js","webpack:///./src/path-tracing/environment.js","webpack:///./src/path-tracing/materials/utils.js","webpack:///./src/path-tracing/sampling.js","webpack:///./src/path-tracing/materials/diffuse.js","webpack:///./src/path-tracing/materials/specular.js","webpack:///./src/path-tracing/materials/refractive.js","webpack:///./src/path-tracing/materials/emission.js","webpack:///./src/path-tracing/materials/mix.js","webpack:///./src/path-tracing/materials/index.js","webpack:///./src/path-tracing/sphere.js","webpack:///./src/path-tracing/scenes/init.js","webpack:///./src/path-tracing/ray.js","webpack:///./src/path-tracing/camera.js","webpack:///./src/path-tracing/photon.js","webpack:///./src/path-tracing/render.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","M_PI","clamp","x","low","high","uniform","Math","random","Vector3","constructor","y","z","Array","isArray","this","[object Object]","v","v1","v2","f","map","sqrt","e","a","abs","round","ceil","floor","trunc","add","scale","sub","copy","set","index","getX","getY","getZ","minDimension","maxDimension","minValue","maxValue","norm2Squared","norm2","normalize","theta","phi","cos","sin","fromAngles","PI","asin","randomInCone","width","u","acos","m1","m2","q","randomInSphere","cross","Environment","type","color","pixels","imgHeight","h","imgWidth","w","getUVValue","rgb","length","background","dir","vy","vx","diffuseReflect","dot","minus","sampleDir","u1","u2","cosTheta","sinTheta","cosineSampleOnHemisphere","idealSpecularReflect","Diffuse","gloss","reflect","photon","iPos","iNorm","addFilter","ray","bounce","Specular","roughness","projectSample","lerp","pow","cosineSamplePowerOnHemisphere","REFRACTIVE_INDEX_OUT","REFRACTIVE_INDEX_IN","Refractive","refractionRecord","nOut","nIn","dRe","outToIn","nl","nn","cos2Phi","dTr","Re","n1","n2","R0","sqrtR0","reflectance0","schlickReflectance","pRe","idealSpecularTransmit","pr","Emission","emission","addEmission","Mix","mix","materials","Error","unmarshal","mat","def","EPSILON","Sphere","material","getMaterial","intersect","op","dop","D","sqrtD","tmin","tmax","initScene","sceneDef","assign","enviroment","objects","unmarshalMaterial","radius","position","unMarshalSphere","Ray","eval","Camera","direction","height","fov","scaling","cx","cy","getDirection","sx","sy","dx","dy","getRay","Infinity","Photon","energy","filter","bounces","mul","pos","scene","buffer","intersectScene","id","radiance","bg","shape","continueProbability","__webpack_exports__","renderFrame","render_init","setVectorFromBuffer","vec","getVectorFromBuffer","split","samples","nbSamples","camera","Ls","Float32Array","ai","L","init","b","onmessage","data","payload","postMessage"],"mappings":"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","file":"325dd0bbad4c981edbc5.worker.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export const M_PI = 3.14159265358979323846\n\nexport function clamp (x, low, high) {\n  return x > high ? high : x < low ? low : x\n}\n\nexport function toByte (x, gamma) {\n  return Math.trunc(clamp(255.0 * Math.pow(x, 1.0 / gamma), 0.0, 255.0))\n}\n","export function uniform () {\n  return Math.random()\n}\n","import { clamp } from './math_tools'\nimport { uniform } from './random'\n\nclass Vector3 {\n  constructor (x, y, z) {\n    if (Array.isArray(x)) {\n      this.x = x[0]\n      this.y = x[1]\n      this.z = x[2]\n    } else {\n      this.x = x\n      this.y = y\n      this.z = z\n    }\n  }\n\n  static minus (v) {\n    return new Vector3(-v.x, -v.y, -v.z)\n  }\n\n  static add (v1, v2) {\n    return new Vector3(v1.x + v2.x, v1.y + v2.y, v1.z + v2.z)\n  }\n\n  static sub (v1, v2) {\n    return new Vector3(v1.x - v2.x, v1.y - v2.y, v1.z - v2.z)\n  }\n\n  static scale (v, s) {\n    return new Vector3(v.x * s, v.y * s, v.z * s)\n  }\n\n  static mul (v1, v2) {\n    return new Vector3(v1.x * v2.x, v1.y * v2.y, v1.z * v2.z)\n  }\n\n  static dot (v1, v2) {\n    return v1.x * v2.x + v1.y * v2.y + v1.z * v2.z\n  }\n\n  static cross (v1, v2) {\n    return new Vector3(\n      v1.y * v2.z - v1.z * v2.y,\n      v1.z * v2.x - v1.x * v2.z,\n      v1.x * v2.y - v1.y * v2.x\n    )\n  }\n\n  static eq (v1, v2) {\n    return v1.x === v2.x && v1.y === v2.y && v1.z === v2.z\n  }\n\n  static ne (v1, v2) {\n    return v1.x !== v2.x || v1.y !== v2.y || v1.z !== v2.z\n  }\n\n  static lt (v1, v2) {\n    return v1.x < v2.x && v1.y < v2.y && v1.z < v2.z\n  }\n\n  static le (v1, v2) {\n    return v1.x <= v2.x && v1.y <= v2.y && v1.z <= v2.z\n  }\n\n  static gt (v1, v2) {\n    return v1.x > v2.x && v1.y > v2.y && v1.z > v2.z\n  }\n\n  static ge (v1, v2) {\n    return v1.x >= v2.x && v1.y >= v2.y && v1.z >= v2.z\n  }\n\n  static map (f, v) {\n    return new Vector3(f(v.x), f(v.y), f(v.z))\n  }\n\n  static sqrt (v) {\n    return Vector3.map(Math.sqrt, v)\n  }\n\n  static pow (v, e) {\n    let fixedPow = a => a ** e\n    return Vector3.map(fixedPow, v)\n  }\n\n  static abs (v) {\n    return Vector3.map(Math.abs, v)\n  }\n\n  static round (v) {\n    return Vector3.map(Math.round, v)\n  }\n\n  static ceil (v) {\n    return Vector3.map(Math.ceil, v)\n  }\n\n  static floor (v) {\n    return Vector3.map(Math.floor, v)\n  }\n\n  static trunc (v) {\n    return Vector3.map(Math.trunc, v)\n  }\n\n  static clamp (v, low, high) {\n    let fixedClamp = a => clamp(a, low, high)\n    return Vector3.map(fixedClamp, v)\n  }\n\n  static lerp (a, v1, v2) {\n    return Vector3.add(v1, Vector3.scale(Vector3.sub(v2, v1), a))\n  }\n\n  static permute (v, x, y, z) {\n    return new Vector3(v.get(x), v.get(y), v.get(z))\n  }\n\n  copy () {\n    return new Vector3(this.x, this.y, this.z)\n  }\n\n  set (x, y, z) {\n    this.x = x\n    this.y = y\n    this.z = z\n  }\n\n  get (index) {\n    switch (index) {\n      case 0:\n        return this.x\n      case 1:\n        return this.y\n      default:\n        return this.z\n    }\n  }\n  getX () {\n    return this.x\n  }\n  getY () {\n    return this.y\n  }\n  getZ () {\n    return this.z\n  }\n\n  minDimension () {\n    return this.x < this.y && this.x < this.z ? 0 : this.y < this.z ? 1 : 2\n  }\n  maxDimension () {\n    return this.x > this.y && this.x > this.z ? 0 : this.y > this.z ? 1 : 2\n  }\n  minValue () {\n    return this.x < this.y && this.x < this.z\n      ? this.x\n      : this.y < this.z ? this.y : this.z\n  }\n  maxValue () {\n    return this.x > this.y && this.x > this.z\n      ? this.x\n      : this.y > this.z ? this.y : this.z\n  }\n\n  norm2Squared () {\n    return this.x * this.x + this.y * this.y + this.z * this.z\n  }\n\n  norm2 () {\n    return Math.sqrt(this.norm2Squared())\n  }\n\n  normalize () {\n    let a = 1.0 / this.norm2()\n    this.x *= a\n    this.y *= a\n    this.z *= a\n    return this\n  }\n\n  static fromAngles (theta, phi) {\n    return new Vector3(\n      Math.cos(theta) * Math.cos(phi),\n      Math.sin(phi),\n      Math.sin(theta) * Math.cos(phi)\n    )\n  }\n  static randomInSphere () {\n    return Vector3.fromAngles(\n      uniform() * Math.PI * 2,\n      Math.asin(uniform() * 2 - 1)\n    )\n  }\n\n  randomInCone (width) {\n    const u = uniform()\n    const v = uniform()\n    const theta = width * 0.5 * Math.PI * (1 - 2 * Math.acos(u) / Math.PI)\n    const m1 = Math.sin(theta)\n    const m2 = Math.cos(theta)\n    const a = v * 2 * Math.PI\n    const q = Vector3.randomInSphere()\n    const s = Vector3.cross(this, q)\n    const t = Vector3.cross(this, s)\n    let d = Vector3.scale(s, m1 * Math.cos(a))\n    d = Vector3.add(d, Vector3.scale(t, m1 * Math.sin(a)))\n    d = Vector3.add(d, Vector3.scale(this, m2))\n    return d.normalize()\n  }\n}\n\nexport default Vector3\n","import Vector3 from './vector.js'\n\nexport const loadImageData = path => {\n  const image = document.createElement('img')\n  const canvas = document.createElement('canvas')\n  const context = canvas.getContext('2d')\n  return new Promise((resolve, reject) => {\n    image.src = path\n    image.addEventListener('load', () => {\n      canvas.width = image.width\n      canvas.height = image.height\n      context.drawImage(image, 0, 0, canvas.width, canvas.height)\n      const pixels = context.getImageData(0, 0, canvas.width, canvas.height)\n        .data\n      resolve({ pixels, w: image.width, h: image.height })\n    })\n  })\n}\n\nclass Environment {\n  constructor (value) {\n    if (value instanceof Vector3) {\n      this.type = 'color'\n      this.color = value.copy()\n    } else if (value == null) {\n      this.type = 'color'\n      this.color = new Vector3(0, 0, 0)\n    } else if (Array.isArray(value)) {\n      this.type = 'color'\n      this.color = new Vector3(value)\n    } else {\n      this.type = 'image'\n      this.pixels = value.pixels\n      this.imgHeight = value.h\n      this.imgWidth = value.w\n    }\n  }\n\n  getUVValue (u, v) {\n    const x = u * this.imgWidth\n    const y = v * this.imgHeight\n    const index = (Math.floor(y) * this.imgWidth + Math.floor(x)) * 4\n    const rgb = new Vector3(\n      this.pixels[index],\n      this.pixels[index + 1],\n      this.pixels[index + 2]\n    )\n    const scale = rgb.length > 441 ? 2 : 1\n    return Vector3.scale(rgb, scale / 255)\n  }\n\n  background (dir) {\n    if (this.type === 'color') {\n      return this.color\n    }\n\n    const d = Math.sqrt(dir.x * dir.x + dir.y * dir.y)\n    const r = 0.159154943 * Math.acos(dir.z) / d\n    const u = 0.5 + dir.x * r\n    const v = 0.5 + dir.y * -r\n\n    return this.getUVValue(u, v)\n  }\n}\n\nexport default Environment\n","import Vector3 from '../vector'\nimport { clamp } from '../math_tools'\nimport { uniform } from '../random'\nimport {\n  cosineSamplePowerOnHemisphere,\n  cosineSampleOnHemisphere\n} from '../sampling'\n\nconst vy = new Vector3(0.0, 1.0, 0.0)\nconst vx = new Vector3(1.0, 0.0, 0.0)\n\nexport function diffuseReflect (d, n) {\n  let w = Vector3.dot(n, d) < 0 ? n : Vector3.minus(n)\n  let u = Vector3.cross(Math.abs(w.x) > 0.1 ? vy : vx, w).normalize()\n  let v = Vector3.cross(w, u)\n\n  let sampleDir = cosineSampleOnHemisphere(uniform(), uniform())\n\n  return Vector3.add(\n    Vector3.add(Vector3.scale(u, sampleDir.x), Vector3.scale(v, sampleDir.y)),\n    Vector3.scale(w, sampleDir.z)\n  ).normalize()\n}\n\nexport function projectSample (w, sampleDir) {\n  let u = Vector3.cross(Math.abs(w.x) > 0.1 ? vy : vx, w).normalize()\n  let v = Vector3.cross(w, u)\n\n  return Vector3.add(\n    Vector3.add(Vector3.scale(u, sampleDir.x), Vector3.scale(v, sampleDir.y)),\n    Vector3.scale(w, sampleDir.z)\n  ).normalize()\n}\n\nexport function idealSpecularReflect (d, n) {\n  const dot = Vector3.dot(n, d)\n  return Vector3.sub(d, Vector3.scale(n, 2.0 * dot))\n}\n\nexport function reflectance0 (n1, n2) {\n  let sqrtR0 = (n1 - n2) / (n1 + n2)\n  return sqrtR0 * sqrtR0\n}\n\nexport function schlickReflectance (n1, n2, c) {\n  let R0 = reflectance0(n1, n2)\n  return R0 + (1 - R0) * c * c * c * c * c\n}\n\nexport function idealSpecularTransmit (d, n, nOut, nIn) {\n  let dRe = idealSpecularReflect(d, n, 0, 0)\n\n  let outToIn = Vector3.dot(n, d) < 0\n  let nl = outToIn ? n : Vector3.minus(n)\n  let nn = outToIn ? nOut / nIn : nIn / nOut\n  let cosTheta = Vector3.dot(d, nl)\n  let cos2Phi = 1.0 - nn * nn * (1.0 - cosTheta * cosTheta)\n\n  // Total Internal Reflection\n  if (cos2Phi < 0) {\n    return [dRe, 1.0]\n  }\n\n  let dTr = Vector3.sub(\n    Vector3.scale(d, nn),\n    Vector3.scale(nl, nn * cosTheta + Math.sqrt(cos2Phi))\n  ).normalize()\n  let c = 1.0 - (outToIn ? -cosTheta : Vector3.dot(dTr, n))\n\n  let Re = schlickReflectance(nOut, nIn, c)\n  let pRe = 0.25 + 0.5 * Re\n  if (uniform() < pRe) {\n    return [dRe, Re / pRe]\n  } else {\n    let Tr = 1.0 - Re\n    let pTr = 1.0 - pRe\n    return [dTr, Tr / pTr]\n  }\n}\n","import { M_PI } from './math_tools.js'\nimport Vector3 from './vector.js'\n\nexport function uniformSampleOnHemisphere (u1, u2) {\n  let sinTheta = Math.sqrt(Math.max(0.0, 1.0 - u1 * u1))\n  let phi = 2.0 * M_PI * u2\n  return new Vector3(Math.cos(phi) * sinTheta, Math.sin(phi) * sinTheta, u1)\n}\n\nexport function cosineSampleOnHemisphere (u1, u2) {\n  let cosTheta = Math.sqrt(1.0 - u1)\n  let sinTheta = Math.sqrt(u1)\n  let phi = 2.0 * M_PI * u2\n  return new Vector3(\n    Math.cos(phi) * sinTheta,\n    Math.sin(phi) * sinTheta,\n    cosTheta\n  )\n}\n\nexport function cosineSamplePowerOnHemisphere (u, v, m = 1) {\n  const theta = Math.acos(Math.pow(1 - u, 1 / (1 + m)))\n  const phi = 2 * Math.PI * v\n\n  return new Vector3(\n    Math.cos(phi) * Math.sin(theta),\n    Math.sin(phi) * Math.sin(theta),\n    Math.cos(theta)\n  )\n}\n","import Vector3 from '../vector'\n\nimport { diffuseReflect } from './utils'\n\nclass Diffuse {\n  constructor ({ color, gloss }) {\n    this.color = new Vector3(color)\n    this.gloss = gloss\n  }\n\n  reflect (photon, iPos, iNorm) {\n    photon.addFilter(this.color)\n\n    const d = diffuseReflect(photon.ray.d, iNorm)\n\n    photon.bounce(iPos, d)\n\n    return true\n  }\n}\n\nexport default Diffuse\n","import Vector3 from '../vector'\nimport { uniform } from '../random'\nimport { clamp } from '../math_tools'\nimport { projectSample, idealSpecularReflect } from './utils'\n\nimport { cosineSamplePowerOnHemisphere } from '../sampling'\n\nclass Specular {\n  constructor ({ color, roughness = 0 }) {\n    this.color = new Vector3(color)\n    this.roughness = roughness\n  }\n\n  reflect (photon, iPos, iNorm) {\n    const n =\n      Vector3.dot(iNorm, photon.ray.d) < 0 ? iNorm : Vector3.minus(iNorm)\n\n    let d = idealSpecularReflect(photon.ray.d, n)\n    if (this.roughness !== 0) {\n      d = Vector3.lerp(this.roughness, d, n)\n\n      let sampleDir = cosineSamplePowerOnHemisphere(\n        uniform(),\n        uniform(),\n        1000 - Math.pow(this.roughness, 0.1) * 1000\n      )\n\n      d = projectSample(d, sampleDir)\n    }\n\n    photon.addFilter(this.color)\n    photon.bounce(iPos, d)\n    return true\n  }\n}\n\nexport default Specular\n","import Vector3 from '../vector'\n\nimport { idealSpecularTransmit } from './utils'\n\nconst REFRACTIVE_INDEX_OUT = 1.0\nconst REFRACTIVE_INDEX_IN = 1.5\n\nclass Refractive {\n  constructor ({ color }) {\n    this.color = new Vector3(color)\n  }\n\n  reflect (photon, iPos, iNorm) {\n    let refractionRecord = idealSpecularTransmit(\n      photon.ray.d,\n      iNorm,\n      REFRACTIVE_INDEX_OUT,\n      REFRACTIVE_INDEX_IN\n    )\n    let dTr = refractionRecord[0]\n    let pr = refractionRecord[1]\n\n    photon.addFilter(this.color)\n    photon.addFilter(new Vector3(pr, pr, pr))\n    photon.bounce(iPos, dTr)\n    return true\n  }\n}\n\nexport default Refractive\n","import Vector3 from '../vector'\n\nclass Emission {\n  constructor ({ emission }) {\n    this.emission = new Vector3(emission)\n  }\n\n  reflect (photon, iPos, iNorm) {\n    photon.addEmission(this.emission)\n    return false\n  }\n}\n\nexport default Emission\n","import { unmarshal } from '.'\n\nclass Mix {\n  constructor ({ mix, materials }) {\n    if (materials.length !== 2) {\n      throw new Error('Mix must use two materials')\n    }\n    this.materials = materials.map(unmarshal)\n    this.mix = mix\n  }\n\n  reflect (photon, iPos, iNorm) {\n    let mat\n    if (Math.random() > this.mix) {\n      mat = this.materials[0]\n    } else {\n      mat = this.materials[1]\n    }\n\n    return mat.reflect(photon, iPos, iNorm)\n  }\n}\n\nexport default Mix\n","import Diffuse from './diffuse'\nimport Specular from './specular'\nimport Refractive from './refractive'\nimport Emission from './emission'\nimport Mix from './mix'\n\nexport const unmarshal = def => {\n  switch (def.type) {\n    case 'diffuse':\n      return new Diffuse(def)\n    case 'specular':\n      return new Specular(def)\n    case 'refractive':\n      return new Refractive(def)\n    case 'emission':\n      return new Emission(def)\n    case 'mix':\n      return new Mix(def)\n  }\n}\n","import Vector3 from './vector.js'\nimport { unmarshal as unmarshalMaterial } from './materials'\n\nexport const EPSILON = 1.0e-4\n\nexport const unmarshal = def => {\n  const mat = unmarshalMaterial(def.material)\n  if (mat == null) {\n\n  }\n  return new Sphere(def.radius, new Vector3(def.position), mat)\n}\n\nclass Sphere {\n  constructor (r, p, material) {\n    this.r = r\n    this.p = p.copy()\n    this.material = material\n  }\n\n  getMaterial () {\n    return this.material\n  }\n\n  intersect (ray) {\n    let op = Vector3.sub(this.p, ray.o)\n    let dop = Vector3.dot(ray.d, op)\n    let D = dop * dop - Vector3.dot(op, op) + this.r * this.r\n\n    if (D < 0) {\n      return false\n    }\n\n    let sqrtD = Math.sqrt(D)\n\n    let tmin = dop - sqrtD\n    if (EPSILON < tmin && tmin < ray.length) {\n      ray.length = tmin\n      return true\n    }\n\n    let tmax = dop + sqrtD\n    if (EPSILON < tmax && tmax < ray.length) {\n      ray.length = tmax\n      return true\n    }\n\n    return false\n  }\n}\n\nexport default Sphere\n","import Environment from '../environment'\nimport { unmarshal as unMarshalSphere } from '../sphere'\n\nconst initScene = sceneDef => {\n  return Object.assign({}, sceneDef, {\n    enviroment: new Environment(sceneDef.enviroment),\n    objects: sceneDef.objects.map(o => unMarshalSphere(o))\n  })\n}\n\nexport default initScene\n","import Vector3 from './vector.js'\n\nclass Ray {\n  constructor (o, d, length) {\n    this.o = o.copy()\n    this.d = d.copy()\n    this.length = length\n  }\n\n  eval (t) {\n    return Vector3.add(this.o, Vector3.scale(this.d, t))\n  }\n}\n\nexport default Ray\n","import Vector3 from './vector'\nimport Ray from './ray'\nimport { uniform } from './random'\n\nexport default class Camera {\n  constructor (position, direction, width, height, fov, scaling = 1) {\n    this.position = position\n    this.direction = direction\n    this.width = width * scaling\n    this.height = height * scaling\n    this.cx = new Vector3(this.width * fov / this.height, 0.0, 0.0)\n    this.cy = Vector3.scale(\n      Vector3.cross(this.cx, this.direction).normalize(),\n      fov\n    )\n  }\n\n  getDirection (x, y, sx, sy) {\n    let u1 = 2.0 * uniform()\n    let u2 = 2.0 * uniform()\n    let dx = u1 < 1 ? Math.sqrt(u1) - 1.0 : 1.0 - Math.sqrt(2.0 - u1)\n    let dy = u2 < 1 ? Math.sqrt(u2) - 1.0 : 1.0 - Math.sqrt(2.0 - u2)\n    return Vector3.add(\n      Vector3.add(\n        Vector3.scale(this.cx, ((sx + 0.5 + dx) / 2.0 + x) / this.width - 0.5),\n        Vector3.scale(this.cy, ((sy + 0.5 + dy) / 2.0 + y) / this.height - 0.5)\n      ),\n      this.direction\n    )\n  }\n\n  getRay (x, y, sx, sy) {\n    const d = this.getDirection(x, y, sx, sy)\n\n    return new Ray(\n      Vector3.add(this.position, Vector3.scale(d, 130)),\n      d.normalize(),\n      Infinity\n    )\n  }\n}\n","import Vector3 from './vector.js'\n\nclass Photon {\n  constructor (ray, energy, filter) {\n    this.ray = ray\n    this.energy = energy\n    this.filter = filter\n    this.bounces = 0\n  }\n\n  addEmission (emission) {\n    this.energy = Vector3.add(this.energy, Vector3.mul(this.filter, emission))\n  }\n\n  addFilter (color) {\n    this.filter = Vector3.mul(this.filter, color)\n  }\n\n  bounce (pos, dir) {\n    this.bounces += 1\n    this.ray.o = pos\n    this.ray.d = dir\n    this.ray.length = Infinity\n  }\n}\n\nexport default Photon\n","import initScene from './scenes/init'\n\nimport Vector3 from './vector.js'\nimport Camera from './camera'\nimport Photon from './photon'\n\nimport { uniform } from './random.js'\n\n// Scene\nlet scene\nlet buffer\n\nfunction intersectScene (ray, scene) {\n  let id\n  for (let i = 0; i < scene.objects.length; ++i) {\n    if (scene.objects[i].intersect(ray)) {\n      id = i\n    }\n  }\n  return id\n}\n\n// Radiance\nfunction radiance (ray, scene) {\n  let photon = new Photon(\n    ray,\n    new Vector3(0.0, 0.0, 0.0),\n    new Vector3(1.0, 1.0, 1.0)\n  )\n\n  while (true) {\n    const id = intersectScene(photon.ray, scene)\n    if (id == null) {\n      const bg = scene.enviroment.background(photon.ray.d)\n      photon.addEmission(bg)\n      return photon.energy\n    }\n\n    let shape = scene.objects[id]\n    let p = photon.ray.eval(photon.ray.length)\n    let n = Vector3.sub(p, shape.p).normalize()\n\n    const cont = shape.material.reflect(photon, p, n)\n\n    if (!cont) {\n      return photon.energy\n    }\n\n    // Russian roulette\n    if (photon.bounces > 4) {\n      let continueProbability = photon.filter.maxValue()\n      if (uniform() >= continueProbability) {\n        return photon.energy\n      }\n      photon.filter = Vector3.scale(photon.filter, 1 / continueProbability)\n    }\n  }\n}\n\nconst setVectorFromBuffer = (buffer, i, vec) => {\n  const index = i * 3\n  buffer[index] = vec.x\n  buffer[index + 1] = vec.y\n  buffer[index + 2] = vec.z\n}\n\nconst getVectorFromBuffer = (buffer, i) => {\n  const index = i * 3\n  return new Vector3(buffer[index], buffer[index + 1], buffer[index + 2])\n}\n\n// Main\nexport default function renderFrame (width, height, split, samples) {\n  let nbSamples = samples\n\n  const camera = new Camera(\n    new Vector3(scene.camera.position),\n    new Vector3(scene.camera.direction).normalize(),\n    width,\n    height,\n    scene.camera.fov\n  )\n\n  let Ls = new Float32Array(camera.width * split.h * 3)\n\n  for (let y = split.y; y < split.y + split.h; ++y) {\n    // pixel row\n    for (let x = 0; x < camera.width; ++x) {\n      // pixel column\n      // let i = (camera.height - 1 - y) * camera.width + x\n      let ai = (y - split.y) * camera.width + x\n      for (let sy = 0; sy < 2; ++sy) {\n        // 2 subpixel row\n        for (let sx = 0; sx < 2; ++sx) {\n          // 2 subpixel column\n          let L = new Vector3(0.0, 0.0, 0.0)\n          for (let s = 0; s < nbSamples; ++s) {\n            //  samples per subpixel\n\n            const r = camera.getRay(x, y, sx, sy)\n\n            L = Vector3.add(\n              L,\n              Vector3.scale(radiance(r, scene), 1.0 / nbSamples)\n            )\n          }\n          setVectorFromBuffer(\n            Ls,\n            ai,\n            Vector3.add(\n              getVectorFromBuffer(Ls, ai),\n              Vector3.scale(Vector3.clamp(L, 0.0, 1.0), 0.25)\n            )\n          )\n        }\n      }\n    }\n  }\n\n  buffer.set(Ls, split.y * camera.width * 3)\n}\n\nexport const init = (b, s) => {\n  buffer = new Float32Array(b)\n  scene = initScene(s)\n}\n\n// As worker\nonmessage = function (e) {\n  if (e.data.type === 'init') {\n    init(e.data.payload.buffer, e.data.payload.scene)\n  } else if (e.data.type === 'render') {\n    const { samples, width, split, height } = e.data.payload\n\n    renderFrame(width, height, split, samples)\n\n    postMessage({\n      type: 'render_finished'\n    })\n  }\n}\n"],"sourceRoot":""}